## 德州扑克

[toc]

### 目标

在给定的规则约束下，用尽量少的语言使读者能够理解清楚德州扑克的游戏规则；各种场景都能在本文中找到线索并推论出最终结果。

### 概述

- 德州扑克是一种玩家对玩家的公共牌类游戏，一共有52张牌，没有王牌。
- 一局游戏由2-10名玩家组成
- 每名玩家会携带初始筹码，在每一轮发牌之后，可以选择：下注、加注、弃牌、过牌、All in
- 经过4轮系统发牌、玩家操作之后，若台面上仍然存在多名玩家。游戏会进入“摊牌”阶段，持大牌者获胜并赢得奖金。
- 游戏顺序是从庄家的左手边开始，顺时针进行

### 游戏进程

```mermaid
graph LR
  sys_send(发牌) -->user_operate(操作):::userClass
  user_operate-->sys_isRoundOver{是否轮次结束}
  sys_isRoundOver-->|Yes| sys_isGameOver{是否游戏结束}
  sys_isRoundOver-->|No| user_operate
  sys_isGameOver-->|Yes| sys_comapre(摊牌&奖金分配)
  sys_isGameOver-->|No| sys_send

  classDef userClass fill:#f96;
```

### 发牌

- 第一轮（Pre-flop）：从庄家左手位开始顺时针方向每人发两张底牌，牌面朝下
- 第二轮（Flop-翻牌）：切掉一张牌，桌面上发出三张公共牌，牌面朝上
- 第三轮（Turn-转牌）：切掉一张牌，发出第四张公共牌，牌面朝上
- 第四轮（River-河牌）：发出第五张公共牌，牌面朝上

### 玩家

- 庄家：每一轮下注时，最后一个行动的玩家。当一局牌局结束后，庄家按照顺时针方向下移一位。
- 小盲注：庄家左手边第一名玩家，第一轮第一个下注且不能弃牌
- 大盲注：庄家左手边第二名玩家，第一轮第二个下注，下注金额为小盲注的2倍

### 一个轮次内，玩家的操作

#### 下注（Bet）

- 玩家本轮投注金额=当前最小下注金额
- 若您为本轮游戏第一个操作的玩家，初始投注金额为￥10
- 若玩家剩余筹码小于最小下注金额，无法选择此操作

Case: 所有玩家都选择Bet

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）[^1]   | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Bet        | CD             | /              | 20   |
| C（100）       | 10           | Bet        | D              | /              | 30   |
| D（100）       | 10           | Bet        | /              | /              | 40   |

#### 加注（Raise）

- 玩家本轮投注金额=当前最小下注金额+￥10
- 本轮第一个操作的玩家无法选择此操作
- 若玩家剩余筹码小于最小下注金额，无法选择此操作
- 一名玩家加注后，之前操作的玩家需要重新选择操作，一个轮次内最多允许加注3次。

Case: 一名玩家加注

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Raise      | CDA            | /              | 30   |
| C（100）       | 20           | Bet        | DA             | /              | 50   |
| D（100）       | 20           | Bet        | A              | /              | 70   |
| A（90）        | 20           | Bet        | /              | /              | 80   |

Case: 多名玩家加注

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Raise      | CDA            | /              | 30   |
| C（100）       | 20           | Bet        | DA             | /              | 50   |
| D（100）       | 20           | Bet        | A              | /              | 70   |
| A（90）        | 20           | Raise      | BCD            | /              | 90   |
| B（80）        | 30           | Bet        | CD             | /              | 100  |
| C（80）        | 30           | Bet        | D              | /              | 110  |
| D（80）        | 10           | Bet        | /              | /              | 120  |

#### 弃牌（Fold）

- 玩家可以主动弃牌被迫弃牌（若玩家剩余筹码小于最小下注金额）
- 弃牌后，玩家不再参与后续轮次并损失投注金额。

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（5）         | 10           | Fold       | CD             | B              | 10   |
| C（100）       | 10           | Bet        | D              | /              | 20   |
| D（100）       | 10           | Fold       | /              | BD             | 20   |

#### 过牌（Pass）

- 跳过给下一名玩家操作，自己则进入到【等待操作玩家】的队尾
- 最后一个【等待操作的玩家】不能过牌
- 处在【过牌】状态的玩家不能过牌

Case: 一名玩家过牌

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Bet        | CD             | /              | 20   |
| C（100）       | 10           | Pass       | D[C] [^2]      | /              | 20   |
| D（100）       | 10           | Bet        | [C]            | /              | 30   |
| C（100）       | 10           | Bet        | /              | /              | 40   |

Case: 多名玩家过牌，处在过牌状态的玩家，无法过牌

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Bet        | CD             | /              | 20   |
| C（100）       | 10           | Pass       | D[C]           | /              | 20   |
| D（100）       | 10           | Pass       | [CD]           | /              | 20   |
| C（100）       | 10           | Bet        | [D]            | /              | 30   |
| D（100）       | 10           | Bet        | /              | /              | 40   |

Case: 多名玩家过牌、加注

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池 |
| -------------- | ------------ | ---------- | -------------- | -------------- | ---- |
| A（100）       | 10           | Bet        | BCD            | /              | 10   |
| B（100）       | 10           | Pass       | CD[B]          | /              | 10   |
| C（100）       | 10           | Rasie      | D[B]A          | /              | 30   |
| D（100）       | 20           | Pass       | [B]A[D]        | /              | 30   |
| B（100）       | 20           | Rasie      | A[D]C          | /              | 60   |
| A（90）        | 30           | Bet        | [D]C           | /              | 80   |
| D（100）       | 30           | Bet        | C              | /              | 110  |
| C（80）        | 30           | Bet        | /              | /              | 120  |

#### All in

- 玩家本轮投注金额 = 玩家剩余筹码金额。
- 有玩家All in后，此时新的最小下注金额=max(旧的最小下注金额，All in金额)。
- 若新的最小下注金额 > 旧的最小下注金额，则之前操作的玩家需要重新选择操作。
- 若新的最小下注金额 = 旧的最小下注金额，则奖池会进行分裂：其中一个，每名玩家投注的金额为All in的金额；另一个，每名玩家投注的金额为旧的最小下注金额 - All in的金额。

Case：一名玩家All in，All in金额小于最小下注金额

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池                        | 奖池’               |
| -------------- | ------------ | ---------- | -------------- | -------------- | --------------------------- | ------------------- |
| A（100）       | 10           | Bet        | BCD            | /              | A:10                        |                     |
| B（5）         | 10           | All in     | CD             | /              | A:5<br/>B:5                 | A:5                 |
| C（100）       | 10           | Bet        | D              | /              | A:5<br/>B:5<br/>C:5         | A:5<br/>C:5         |
| D（100）       | 10           | Bet        | /              | /              | A:5<br/>B:5<br/>C:5<br/>D:5 | A:5<br/>C:5<br/>D:5 |

Case：一名玩家All in，All in金额大于最小下注金额

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池                            |
| -------------- | ------------ | ---------- | -------------- | -------------- | ------------------------------- |
| A（100）       | 10           | Bet        | BCD            | /              | A:10                            |
| B（15）        | 10           | All in     | CDA            | /              | A:10<br/>B:15                   |
| C（100）       | 15           | Bet        | DA             | /              | A:10<br/>B:15<br/>C:15          |
| D（100）       | 15           | Bet        | A              | /              | A:10<br/>B:15<br/>C:15<br/>D:15 |
| A（90）        | 15           | Bet        | /              | /              | A:15<br/>B:15<br/>C:15<br/>D:15 |

Case：多名玩家All in，All in金额都小于最小下注金额

| 当前操作的玩家 | 最小下注金额 | 玩家的操作 | 等待操作的玩家 | 退出游戏的玩家 | 奖池                        | 奖池’               | 奖池‘’      |
| -------------- | ------------ | ---------- | -------------- | -------------- | --------------------------- | ------------------- | ----------- |
| A（100）       | 10           | Bet        | BCD            | /              | A:10                        |                     |             |
| B（5）         | 10           | All in     | CD             | /              | A:5<br/>B:5                 | A:5                 |             |
| C（8）         | 10           | All in     | D              | /              | A:5<br/>B:5<br/>C:5         | A:3<br/>C:3         | A:2         |
| D（100）       | 10           | Bet        | /              | /              | A:5<br/>B:5<br/>C:5<br/>D:5 | A:3<br/>C:3<br/>D:3 | A:2<br/>D:2 |

### 轮次是否结束

- 【等待操作的玩家】为空时，本轮结束

### 游戏是否结束

1. 任意轮次内，场上只剩一名玩家时，游戏结束
2. 第四轮结束后

### 摊牌&奖金分配

1. 若场上只剩一名玩家，则该玩家成为赢家，获得奖池内所有奖金
2. 若场上仍有多名玩家，则进入摊牌阶段，仍未退出的玩家从手牌与河牌挑选最大的组合，进行比较
3. 如有一人胜出，则该玩家成为赢家，获得奖池内所有奖金
4. 如平局，则赢家平分奖池内所有奖金

| 奖池                            | 获胜的玩家 | 玩家收益               |
| ------------------------------- | ---------- | ---------------------- |
| A:15<br/>B:15<br/>C:15<br/>D:15 | A          | A:60                   |
| A:15<br/>B:15<br/>C:15          | A、B、C    | A:15<br/>B:15<br/>C:15 |

5. 如果存在分裂的奖池，玩家获得他在每个奖池赢得的奖金之和

| 奖池                        | 奖池‘               | 获胜的玩家        | 玩家收益    |
| --------------------------- | ------------------- | ----------------- | ----------- |
| A:5<br/>B:5<br/>C:5<br/>D:5 | A:5<br/>C:5<br/>D:5 | 奖池：A，奖池’：A | A:5 + 5     |
| A:5<br/>B:5<br/>C:5<br/>D:5 | A:5<br/>C:5<br/>D:5 | 奖池：B，奖池’：A | A:5<br/>B:5 |

### 问题

1. 代码实现的角度反向写文档，举例：奖池分裂
2. Holdem拆分

[^1]: A（100），100为此时玩家剩余的筹码
[^2]: [C]，表示玩家C处在【过牌】状态

